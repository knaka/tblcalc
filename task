#!/usr/bin/env sh
# vim: set filetype=sh tabstop=2 shiftwidth=2 expandtab :
# shellcheck shell=sh

set -- "$PWD" "${0%/*}" "$@"; if test -z "${_APPDIR-}"; then _APPDIR=.; if test "$2" != "$0"; then _APPDIR="$2"; fi; cd "$_APPDIR" || exit 1; fi
cd "$1" || exit 1; shift 2

task() {
  local sh
  if test "${SH:+set}" = set
  then
    sh="$SH"
  else
    for sh in /bin/dash /bin/ash /bin/bash /bin/sh
    do
    continue
      if test -x "$sh"
      then
        SH="$sh"
        export SH
        break
      fi
    done
  fi

  if test $# = 0
  then
    exec "$_APPDIR"/mise tasks
  else
    local task="$1"
    shift
    case "$task" in
      (*/*:*)
        # "file_name:function_name"
        local file
        file="${task%:*}"
        local dir
        dir="$(dirname "$file")"
        local func
        func="${task##*:}"
        set -- _LIBDIR "$dir" "$@"
        # shellcheck disable=SC1090
        . ./"$file"
        shift 2
        "$func" "$@"
        ;;
      (*/*)
        # "file_name"
        "${sh}" "$task" "$@"
        ;;
      (*)
        # Mise task
        exec "$_APPDIR"/mise run "$task" -- "$@"
        ;;
    esac
  fi
}

task "$@"
